# TrendRadar AI - Automated News Aggregation Workflow
# This workflow fetches trending news, runs AI analysis, and sends notifications

name: TrendRadar AI Crawler

on:
  # Run every hour
  schedule:
    - cron: '0 * * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      enable_ai:
        description: 'Enable AI analysis'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      force_notify:
        description: 'Force send notifications'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# Prevent concurrent runs
concurrency:
  group: trendradar-crawler
  cancel-in-progress: false

env:
  PYTHON_VERSION: '3.12'
  TZ: 'Asia/Shanghai'

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Set timezone
        run: |
          sudo timedatectl set-timezone ${{ env.TZ }}

      - name: Run TrendRadar AI
        env:
          # Crawler settings
          ENABLE_CRAWLER: 'true'
          REPORT_MODE: ${{ vars.REPORT_MODE || 'daily' }}

          # Push window settings
          PUSH_WINDOW_ENABLED: ${{ vars.PUSH_WINDOW_ENABLED || 'false' }}
          PUSH_WINDOW_START: ${{ vars.PUSH_WINDOW_START || '09:00' }}
          PUSH_WINDOW_END: ${{ vars.PUSH_WINDOW_END || '18:00' }}

          # Notification webhooks (from secrets)
          WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}
          WEWORK_MSG_TYPE: ${{ secrets.WEWORK_MSG_TYPE || 'markdown' }}
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
          BARK_URL: ${{ secrets.BARK_URL }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}

          # AI settings
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ARGS=""
          if [ "${{ github.event.inputs.enable_ai }}" = "false" ]; then
            ARGS="$ARGS --no-ai"
          fi
          if [ "${{ github.event.inputs.force_notify }}" = "true" ]; then
            ARGS="$ARGS --force-notify"
          fi
          python -m src.main $ARGS

      - name: Commit output files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add output files
          git add output/ index.html || true

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update trending news report - $(date +'%Y-%m-%d %H:%M')"
            git push
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trendradar-output-${{ github.run_number }}
          path: output/
          retention-days: 7

  # Deploy to GitHub Pages (optional)
  deploy:
    needs: crawl
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }}

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
